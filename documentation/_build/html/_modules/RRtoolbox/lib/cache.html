<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>RRtoolbox.lib.cache &#8212; RRtoolbox 1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="RRtoolbox 1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for RRtoolbox.lib.cache</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. moduleauthor:: David Toro &lt;davsamirtor@gmail.com&gt;</span>

<span class="sd">:platform: Unix, Windows</span>
<span class="sd">:synopsis: Serialize and Memoize.</span>

<span class="sd">Contains memoizing, caching, serializing and memory-mapping methods so as to let the package</span>
<span class="sd">save its state (persistence) and to let a method &quot;remember&quot; what it processed in a session (with cache) or</span>
<span class="sd">between sessions (memoization and serializization) of the same input contend once processed. It also wraps mmapping</span>
<span class="sd">functions to let objects &quot;live&quot; in the disk (slower but almost unlimited) rather than in memory (faster but limited).</span>

<span class="sd">*@cache* is used as replacement of *@property* to compute a class method once.</span>
<span class="sd">It is computed only one time after which an attribute of the same name is generated in its place.</span>

<span class="sd">*@cachedProperty* is used as replacement of *@property* to compute</span>
<span class="sd">a class method depending on changes in its watched variables.</span>

<span class="sd">*@memoize* used as a general memoizer decorator for functions</span>
<span class="sd">where metadata is generated to disk for persistence.</span>

<span class="sd">Made by Davtoh, powered by joblib.</span>
<span class="sd">Dependent project: https://github.com/joblib/joblib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">future</span> <span class="k">import</span> <span class="n">standard_library</span>
<span class="n">standard_library</span><span class="o">.</span><span class="n">install_aliases</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">past.utils</span> <span class="k">import</span> <span class="n">old_div</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>
<span class="kn">from</span> <span class="nn">.root</span> <span class="k">import</span> <span class="n">NotCallable</span><span class="p">,</span> <span class="n">NotCreatable</span><span class="p">,</span> <span class="n">VariableNotSettable</span><span class="p">,</span> <span class="n">VariableNotDeletable</span><span class="p">,</span> \
    <span class="n">CorruptPersistent</span>

<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    joblib is BSD-licenced (3 clause):</span>

<span class="s2">    This software is OSI Certified Open Source Software. OSI Certified is a</span>
<span class="s2">    certification mark of the Open Source Initiative.</span>

<span class="s2">    Copyright (c) 2009-2011, joblib developpers All rights reserved.</span>

<span class="s2">    Redistribution and use in source and binary forms, with or without modification,</span>
<span class="s2">    are permitted provided that the following conditions are met:</span>

<span class="s2">    1. Redistributions of source code must retain the above copyright notice,</span>
<span class="s2">    this list of conditions and the following disclaimer.</span>

<span class="s2">    2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="s2">    this list of conditions and the following disclaimer in the documentation and/or</span>
<span class="s2">    other materials provided with the distribution.</span>

<span class="s2">    3. Neither the name of Gael Varoquaux. nor the names of other joblib contributors may be used</span>
<span class="s2">    to endorse or promote products derived from this software without specific prior written permission.</span>

<span class="s2">    This software is provided by the copyright holders and contributors &quot;as is&quot; and any</span>
<span class="s2">    express or implied warranties, including, but not limited to, the implied warranties</span>
<span class="s2">    of merchantability and fitness for a particular purpose are disclaimed.</span>

<span class="s2">    In no event shall the copyright owner or contributors be liable for any direct, indirect,</span>
<span class="s2">    incidental, special, exemplary, or consequential damages (including, but not limited to,</span>
<span class="s2">    procurement of substitute goods or services; loss of use, data, or profits; or business</span>
<span class="s2">    interruption) however caused and on any theory of liability, whether in contract, strict</span>
<span class="s2">    liability, or tort (including negligence or otherwise) arising in any way out of the use</span>
<span class="s2">    of this software, even if advised of the possibility of such damage.</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="c1">## READ: https://wiki.python.org/moin/PythonDecoratorLibrary</span>

<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="k">import</span> <span class="n">ref</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">numpy.lib</span> <span class="k">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">numpyLoad</span><span class="p">,</span> <span class="n">save</span> <span class="k">as</span> <span class="n">numpySave</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1">#print &quot;using joblib version&quot;, joblib.__version__</span>

<div class="viewcode-block" id="NotMemorizedFunc"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.NotMemorizedFunc">[docs]</a><span class="k">class</span> <span class="nc">NotMemorizedFunc</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">NotMemorizedFunc</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="MemorizedFunc"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.MemorizedFunc">[docs]</a><span class="k">class</span> <span class="nc">MemorizedFunc</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">MemorizedFunc</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="DynamicMemoizedFunc"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.DynamicMemoizedFunc">[docs]</a><span class="k">class</span> <span class="nc">DynamicMemoizedFunc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">cachedir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">banned</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span> <span class="c1"># the only one that should not be able to change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mmap_mode</span> <span class="o">=</span> <span class="n">mmap_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="n">ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cachedir</span> <span class="o">=</span> <span class="n">cachedir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span> <span class="o">=</span> <span class="n">compress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="n">banned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use</span> <span class="o">=</span> <span class="n">NotMemorizedFunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use</span> <span class="o">=</span> <span class="n">MemorizedFunc</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">,</span><span class="n">cachedir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedir</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">,</span>
                                      <span class="n">mmap_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mmap_mode</span><span class="p">,</span><span class="n">compress</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compress</span><span class="p">,</span>
                                      <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="o">.</span><span class="n">__doc__</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span>
    <span class="nd">@func</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">MemorizedFunc</span><span class="p">,</span><span class="n">NotMemorizedFunc</span><span class="p">,</span><span class="n">DynamicMemoizedFunc</span><span class="p">)):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">func</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="nd">@func</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;property cannot be deleted&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mmap_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap_mode</span>
    <span class="nd">@mmap_mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mmap_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mmap_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mmap_mode</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="nd">@mmap_mode</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">mmap_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;property cannot be deleted&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span>
    <span class="nd">@ignore</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="nd">@ignore</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;property cannot be deleted&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>
    <span class="nd">@verbose</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="nd">@verbose</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;property cannot be deleted&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cachedir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedir</span>
    <span class="nd">@cachedir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cachedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedir</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cachedir</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="nd">@cachedir</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">cachedir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;property cannot be deleted&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span>
    <span class="nd">@compress</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="nd">@compress</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;property cannot be deleted&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span>
    <span class="nd">@enabled</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enabled</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
    <span class="nd">@enabled</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;property cannot be deleted&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="DynamicMemoizedFunc.call_and_shelve"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.DynamicMemoizedFunc.call_and_shelve">[docs]</a>    <span class="k">def</span> <span class="nf">call_and_shelve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="o">.</span><span class="n">call_and_shelve</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>
<div class="viewcode-block" id="DynamicMemoizedFunc.clear"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.DynamicMemoizedFunc.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Memory"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.Memory">[docs]</a><span class="k">class</span> <span class="nc">Memory</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">Memory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper to joblib Memory to have better control.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachedir</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Memory</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="p">,</span> <span class="n">compress</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cachedir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cachedir</span> <span class="o">=</span> <span class="n">cachedir</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cachedir</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    def cache(self, func=None, ignore=None, verbose=None,</span>
<span class="sd">                        mmap_mode=False):</span>
<span class="sd">        &quot;&quot;&quot; Decorates the given function func to only compute its return</span>
<span class="sd">            value for input arguments not cached on disk.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            func: callable, optional</span>
<span class="sd">                The function to be decorated</span>
<span class="sd">            ignore: list of strings</span>
<span class="sd">                A list of arguments name to ignore in the hashing</span>
<span class="sd">            verbose: integer, optional</span>
<span class="sd">                The verbosity mode of the function. By default that</span>
<span class="sd">                of the memory object is used.</span>
<span class="sd">            mmap_mode: {None, &#39;r+&#39;, &#39;r&#39;, &#39;w+&#39;, &#39;c&#39;}, optional</span>
<span class="sd">                The memmapping mode used when loading from cache</span>
<span class="sd">                numpy arrays. See numpy.load for the meaning of the</span>
<span class="sd">                arguments. By default that of the memory object is used.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            decorated_func: MemorizedFunc object</span>
<span class="sd">                The returned object is a MemorizedFunc object, that is</span>
<span class="sd">                callable (behaves like a function), but offers extra</span>
<span class="sd">                methods for cache lookup and management. See the</span>
<span class="sd">                documentation for :class:`joblib.memory.MemorizedFunc`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="sd">        if func is None:</span>
<span class="sd">            # Partial application, to be able to specify extra keyword</span>
<span class="sd">            # arguments in decorators</span>
<span class="sd">            return partial(self.cache, ignore=ignore,</span>
<span class="sd">                                     verbose=verbose, mmap_mode=mmap_mode)</span>
<span class="sd">        if verbose is None:</span>
<span class="sd">            verbose = self._verbose</span>
<span class="sd">        if mmap_mode is False:</span>
<span class="sd">            mmap_mode = self.mmap_mode</span>
<span class="sd">        if isinstance(func, (MemorizedFunc,NotMemorizedFunc,DynamicMemoizedFunc)):</span>
<span class="sd">            func = func.func</span>
<span class="sd">        return DynamicMemoizedFunc(func, cachedir=self.cachedir,</span>
<span class="sd">                                   mmap_mode=mmap_mode,</span>
<span class="sd">                                   ignore=ignore,</span>
<span class="sd">                                   compress=self.compress,</span>
<span class="sd">                                   verbose=verbose,</span>
<span class="sd">                                   timestamp=self.timestamp)&#39;&#39;&#39;</span>
    <span class="n">__call__</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Memory</span><span class="o">.</span><span class="n">cache</span></div>

<div class="viewcode-block" id="Memoizer"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.Memoizer">[docs]</a><span class="k">class</span> <span class="nc">Memoizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">memoizers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">(),</span> <span class="n">ignoreAll</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignoreAll</span> <span class="o">=</span> <span class="n">ignoreAll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="n">ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memoized</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># FOR CLEANING UP handle # flag = True is safe to remove, flag = False is unsafe to remove</span>
        <span class="n">Memoizer</span><span class="o">.</span><span class="n">memoizers</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span>
    <span class="nd">@ignore</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must be callable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="n">temp</span>
    <span class="nd">@ignore</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="Memoizer.makememory"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.Memoizer.makememory">[docs]</a>    <span class="k">def</span> <span class="nf">makememory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cachedir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make memory for :func:`memoize` decorator.</span>

<span class="sd">        :param cachedir: path to save metadata, if left None function is not cached.</span>
<span class="sd">        :param mmap_mode: {None, &#39;r+&#39;, &#39;r&#39;, &#39;w+&#39;, &#39;c&#39;}, optional.</span>
<span class="sd">                    The memmapping mode used when loading from cache</span>
<span class="sd">                    numpy arrays. See numpy.load for the meaning of the</span>
<span class="sd">                    arguments.</span>
<span class="sd">        :param compress: (boolean or integer)</span>
<span class="sd">                    Whether to zip the stored data on disk. If an integer is</span>
<span class="sd">                    given, it should be between 1 and 9, and sets the amount</span>
<span class="sd">                    of compression. Note that compressed arrays cannot be</span>
<span class="sd">                    read by memmapping.</span>
<span class="sd">        :param verbose: (int, optional)</span>
<span class="sd">                    Verbosity flag, controls the debug messages that are issued</span>
<span class="sd">                    as functions are evaluated.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if not cachedir:</span>
<span class="sd">            cachedir = tempfile.mkdtemp() # tempfile.mkdtemp(dir=cachedir)&quot;&quot;&quot;</span>
        <span class="n">MEMORY</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="p">,</span> <span class="n">compress</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MEMORY</span></div>

<div class="viewcode-block" id="Memoizer.memoize"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.Memoizer.memoize">[docs]</a>    <span class="k">def</span> <span class="nf">memoize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decorated functions are faster by trading memory for time, only hashable values can be memoized.</span>

<span class="sd">        :param memory: (Memory or path to folder) if left None function is not cached.</span>
<span class="sd">        :param ignore: (list of strings) A list of arguments name to ignore in the hashing.</span>
<span class="sd">        :param verbose: (integer) Verbosity flag, controls the debug messages that are issued as functions are evaluated.</span>
<span class="sd">        :param mmap_mode: {None, &#39;r+&#39;, &#39;r&#39;, &#39;w+&#39;, &#39;c&#39;}, optional. The memmapping mode used when loading from cache</span>
<span class="sd">                    numpy arrays. See numpy.load for the meaning of the arguments.</span>
<span class="sd">        :return: decorator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span><span class="n">joblib</span><span class="o">.</span><span class="n">Memory</span><span class="p">):</span> <span class="c1"># use provided memory</span>
                <span class="n">memoizedfn</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">ignore</span><span class="p">,</span><span class="n">verbose</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#memoizedfn = DynamicMemoizedFunc(func=fn,cachedir=str(memory),</span>
                <span class="c1">#                ignore=ignore,verbose=verbose, mmap_mode=mmap_mode)</span>
                <span class="n">memoizedfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makememory</span><span class="p">(</span><span class="n">cachedir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span>
                                <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="n">mmap_mode</span><span class="p">)</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1"># TODO solve this, how to test quickly to ignore memoization</span>
                <span class="c1">#perhaps it is better to use dynamicMemoizedFuciton  to prevent comparitions when ignoring a memoization</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreAll</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">memoizedfn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memoized</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">fn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">memoizedfn</span><span class="p">)</span> <span class="c1"># safe to remove</span>
            <span class="k">return</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">decorator</span></div>
    <span class="n">__call__</span> <span class="o">=</span> <span class="n">memoize</span></div>

<span class="n">memoize</span> <span class="o">=</span> <span class="n">Memoizer</span><span class="p">()</span> <span class="c1"># make memoizer manager</span>

<div class="viewcode-block" id="Cache"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.Cache">[docs]</a><span class="k">class</span> <span class="nc">Cache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Descriptor (non-data) for building an attribute on-demand at first use.</span>
<span class="sd">    @cache decorator is used for class methods without inputs (only self reference to the object)</span>
<span class="sd">    and it caches on first compute. ex::</span>

<span class="sd">        class x(object):</span>
<span class="sd">            @cache</span>
<span class="sd">            def method_x(self):</span>
<span class="sd">                return self.data</span>

<span class="sd">    .. note:: Cached data can be deleted in the decorated object to recalculate its value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize cache with a property function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span> <span class="c1"># function handle</span>
    <span class="c1"># if method simulating getattr</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>  <span class="c1"># if trying to get attribute</span>
        <span class="c1"># Build the attribute.</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="c1">#evaluate function over instance</span>
        <span class="c1"># Cache the value;</span>
        <span class="c1"># Creates variable (name) of value (cached) in (instance).</span>
        <span class="c1"># instance.name = cached</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">cached</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cached</span></div>

<div class="viewcode-block" id="cachedProperty"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.cachedProperty">[docs]</a><span class="k">def</span> <span class="nf">cachedProperty</span><span class="p">(</span><span class="n">watch</span><span class="o">=</span><span class="p">[],</span><span class="n">handle</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A memoize decorator of @property decorator specifying what to trigger caching.</span>

<span class="sd">    :param watch: (list of strings) A list of arguments name to watch in the hashing.</span>
<span class="sd">    :param handle: (list of handles or empty list) Provided list is appended with the Memo</span>
<span class="sd">                handle were data is stored for the method and where a clear() function is provided.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#http://code.activestate.com/recipes/576563-cached-property/</span>
    <span class="k">class</span> <span class="nc">Memo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Memo function for cache &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span><span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span><span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">this</span> <span class="o">=</span> <span class="n">Memo</span><span class="p">()</span>
    <span class="n">handle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">noargs</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="c1"># if not watch use this funciton</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">this</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">get</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">withargs</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="c1"># if watch use this function</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">input_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">watch</span> <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">input_values</span> <span class="o">==</span> <span class="n">this</span><span class="o">.</span><span class="n">_input_cache</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">x</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">this</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span><span class="p">{}</span>
                <span class="n">this</span><span class="o">.</span><span class="n">_input_cache</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">this</span><span class="o">.</span><span class="n">_input_cache</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_values</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">get</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">watch</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span> <span class="c1"># if not arguments</span>
        <span class="k">return</span> <span class="n">noargs</span><span class="p">(</span><span class="n">watch</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">watch</span><span class="o">==</span><span class="p">[]:</span>
        <span class="k">return</span> <span class="n">noargs</span>
    <span class="k">return</span> <span class="n">withargs</span></div>


<div class="viewcode-block" id="ObjectGetter"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter">[docs]</a><span class="k">class</span> <span class="nc">ObjectGetter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates or get instance object depending if it is alive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callfunc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="o">**</span><span class="n">annotations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param callfunc: function to create object</span>
<span class="sd">        :param obj: (optional) alive object already obtained from callfunc</span>
<span class="sd">        :param callback: function called on object destruction</span>
<span class="sd">        :param annotations: annotations to self (this object can be used to save info or statistics)</span>

<span class="sd">        Example::</span>

<span class="sd">            class constructor: pass</span>
<span class="sd">            myobj = constructor() # created hard reference</span>
<span class="sd">            getobj = objectGetter(myobj, callfunc=constructor) # created getter</span>
<span class="sd">            assert myobj is getobj() # it uses the same reference as myobj</span>
<span class="sd">            del myobj # myobj reference lost</span>
<span class="sd">            a = getobj() # created (+1) other object from constructor</span>
<span class="sd">            b = getobj() # it uses the same hard reference a</span>

<span class="sd">            myobj = constructor()</span>
<span class="sd">            getobj = objectGetter(None, callfunc=constructor)</span>
<span class="sd">            assert myobj is not getobj() # created (+1) other object from constructor</span>
<span class="sd">            a = getobj() # this created (+1) again because there was not reference to object</span>
<span class="sd">            b = getobj() # it uses the same hard reference a</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ObjectGetter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callfunc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">callfunc</span> <span class="o">=</span> <span class="n">callfunc</span><span class="p">,</span> <span class="o">**</span><span class="n">annotations</span><span class="p">)</span>

<div class="viewcode-block" id="ObjectGetter.update"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">callfunc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;callfunc&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callfunc</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">callfunc</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">NotCallable</span><span class="p">(</span><span class="s2">&quot;callfunc </span><span class="si">{}</span><span class="s2"> is not callable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">callfunc</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callfunc</span> <span class="o">=</span> <span class="n">callfunc</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="n">callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="ObjectGetter.getObj"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter.getObj">[docs]</a>    <span class="k">def</span> <span class="nf">getObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">throw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ob</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">throw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ob</span></div>
    <span class="n">__call__</span> <span class="o">=</span> <span class="n">getObj</span>

<div class="viewcode-block" id="ObjectGetter.create"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">throw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an object and keep reference.</span>

<span class="sd">        :param throw: if there is not creation function throws error.</span>
<span class="sd">        :return: created object.</span>

<span class="sd">        .. warning:: previous object reference is lost even if it was alive.</span>

<span class="sd">        .. note:: Recommended only to use when object from current reference is dead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isCreatable</span><span class="p">():</span> <span class="c1"># to create</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callfunc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ob</span>
        <span class="k">elif</span> <span class="n">throw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotCreatable</span><span class="p">(</span><span class="s2">&quot;No callfunc to create object&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ObjectGetter.raw"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter.raw">[docs]</a>    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get object from reference.</span>
<span class="sd">        :return: None if object is dead, object itself if is alive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span><span class="p">:</span> <span class="c1"># if in references</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ob</span></div>

<div class="viewcode-block" id="ObjectGetter.isAlive"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter.isAlive">[docs]</a>    <span class="k">def</span> <span class="nf">isAlive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test if object of reference is alive</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ObjectGetter.isCreatable"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter.isCreatable">[docs]</a>    <span class="k">def</span> <span class="nf">isCreatable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test if can create object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callfunc</span></div>

<div class="viewcode-block" id="ObjectGetter.isGettable"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ObjectGetter.isGettable">[docs]</a>    <span class="k">def</span> <span class="nf">isGettable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test if object can be gotten either by reference or creation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isCreatable</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAlive</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="Retriever"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.Retriever">[docs]</a><span class="k">class</span> <span class="nc">Retriever</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    keep track of references and create objects on demand if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">references</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Retriever.register"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.Retriever.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register object to retrieve.</span>

<span class="sd">        :param key: hashable key to retrieve</span>
<span class="sd">        :param method: callable method to get object</span>
<span class="sd">        :param instance: object instance already created from method</span>
<span class="sd">        :return:</span>

<span class="sd">        Example::</span>

<span class="sd">            def mymethod():</span>
<span class="sd">                class constructor: pass</span>
<span class="sd">                return constructor()</span>

<span class="sd">            ret = retriever()</span>
<span class="sd">            ret[&quot;obj&quot;] = mymethod # register creating method in &quot;obj&quot;</span>
<span class="sd">            im = ret[&quot;obj&quot;] # get object (created obj +1, with reference)</span>
<span class="sd">            assert im is ret[&quot;obj&quot;] # check that it gets the same object</span>
<span class="sd">            # it remembers that &quot;obj&quot; is last registered or fetched object too</span>
<span class="sd">            assert ret() is ret()</span>
<span class="sd">            # lets register with better control (created obj2 +1, no reference)</span>
<span class="sd">            ret.register(&quot;obj2&quot;,mymethod(),mymethod)</span>
<span class="sd">            # proves that obj2 is not the same as obj (created obj2 +1, no reference)</span>
<span class="sd">            assert ret() is not ret[&quot;obj&quot;]</span>
<span class="sd">            print list(ret.iteritems()) # get items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjectGetter</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">callfunc</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span> <span class="o">=</span> <span class="n">key</span> <span class="c1"># register last key</span></div>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">key</span><span class="p">]()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">)</span></div>

<div class="viewcode-block" id="LazyDict"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.LazyDict">[docs]</a><span class="k">class</span> <span class="nc">LazyDict</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create objects on demand if needed. call the instance with keys to prevent it</span>
<span class="sd">    from using lazy evaluations (e.g. instead of self[key] use self(key) to prevent</span>
<span class="sd">    recursion). Containing operations are safe to prevent recursion (e.g. if key in self</span>
<span class="sd">    instead of self[key]). In addition use self.isLazy flag to enable or disable lazy</span>
<span class="sd">    operations to prevent possible recursions when getter is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">getter</span><span class="p">,</span> <span class="n">dictionary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">getter</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NotCallable</span><span class="p">(</span><span class="s2">&quot;getter must be a callable function to process keys&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dictionary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getter</span> <span class="o">=</span> <span class="n">getter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isLazy</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">:</span>
                <span class="c1"># try to use cached data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># always compute data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isLazy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">:</span>
                <span class="c1"># for lazy or to recompute</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#self[key] # It can create a recursion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ResourceManager"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager">[docs]</a><span class="k">class</span> <span class="nc">ResourceManager</span><span class="p">(</span><span class="n">Retriever</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    keep track of references, create objects on demand, manage their memory and optimize for better performance.</span>

<span class="sd">    :param maxMemory: (None) max memory in specified unit to keep in check optimization (it does</span>
<span class="sd">                    not mean that memory never surpasses maxMemory).</span>
<span class="sd">    :param margin: (0.8) margin from maxMemory to trigger optimization.</span>
<span class="sd">                    It is in percentage of maxMemory ranging from 0 (0%) to maximum 1 (100%).</span>
<span class="sd">                    So optimal memory is inside range: maxMemory*margin &lt; Memory &lt; maxMemory</span>
<span class="sd">    :param unit: (MB) maxMemory unit, it can be GB (Gigabytes), MB (Megabytes), B (bytes)</span>
<span class="sd">    :param all: if True used memory is from all alive references,</span>
<span class="sd">                    if False used memory is only from keptAlive references.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxMemory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">margin</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="nb">all</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResourceManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c1">#self.references is a dictionary containing all the references</span>
        <span class="c1">#self._lastkey is effectively the last key to use when Manager is called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># used memory in bytes of references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refMemory</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># used memory in bytes of keptAlive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># maximum memory in bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># unit of memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># convert to any unit: equivalence with bytes from unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_margin</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># private data of margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># private data representing _maxMemory*_margin in bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="o">=</span> <span class="nb">all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># key of objects likely to destroy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whitelist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># key of objects likely to keep in memory and only delete in extreme cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># objects currently being kept alive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># if true print debugging messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># invert any order made by user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># mapping methods for user defined fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># (&quot;size&quot;,&quot;_call&quot;,&quot;_fail&quot;,&quot;_mean&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span> <span class="c1"># set units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span> <span class="c1"># margin of percentage (0 to 1) of memory</span>
        <span class="k">if</span> <span class="n">maxMemory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxMemory</span> <span class="o">=</span> <span class="n">maxMemory</span> <span class="c1"># set maximum memory</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets object from key and collect statistical data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">getter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">getter</span><span class="o">.</span><span class="n">_iddleT</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">getter</span><span class="o">.</span><span class="n">_iddleT</span><span class="p">)</span> <span class="c1"># iddle time</span>
        <span class="n">wasAlive</span> <span class="o">=</span> <span class="n">getter</span><span class="o">.</span><span class="n">isAlive</span><span class="p">()</span>
        <span class="n">wasAtFail</span> <span class="o">=</span> <span class="n">getter</span><span class="o">.</span><span class="n">_fails</span><span class="o">&gt;</span><span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span><span class="n">throw</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wasAtFail</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resetGetter</span><span class="p">(</span><span class="n">getter</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotCreatable</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">getter</span><span class="o">.</span><span class="n">_fails</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># keep accumulating fails</span>
        <span class="n">getter</span><span class="o">.</span><span class="n">_calls</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># actual calls</span>
        <span class="c1"># time it and increase _calls</span>
        <span class="k">if</span> <span class="n">getter</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span> <span class="c1"># get successive times</span>
            <span class="n">getter</span><span class="o">.</span><span class="n">_processT</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span> <span class="o">+</span> <span class="n">getter</span><span class="o">.</span><span class="n">_processT</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># process time</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># if first call then get first profile time</span>
            <span class="n">getter</span><span class="o">.</span><span class="n">_processT</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="p">:</span>
            <span class="n">toWhiteList</span> <span class="o">=</span>  <span class="n">getter</span><span class="o">.</span><span class="n">_fails</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitelist</span> <span class="ow">and</span> <span class="n">getter</span><span class="o">.</span><span class="n">_processT</span> <span class="o">&gt;</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">wasAlive</span><span class="p">:</span> <span class="c1"># it was not alive but now it was created</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizeObject</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">getter</span><span class="p">,</span><span class="n">toWhiteList</span><span class="o">=</span><span class="n">toWhiteList</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span> <span class="o">=</span> <span class="n">key</span> <span class="c1"># update key once finished</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="c1"># tries to _free if kept alive</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># delete entry</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="p">:</span> <span class="c1"># clear form black list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitelist</span><span class="p">:</span> <span class="c1"># clear form white list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">whitelist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="ResourceManager.getSizeOf"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager.getSizeOf">[docs]</a>    <span class="k">def</span> <span class="nf">getSizeOf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">__sizeof__</span><span class="p">()</span><span class="c1">#getsizeof(item,0)</span></div>

<div class="viewcode-block" id="ResourceManager.optimizeObject"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager.optimizeObject">[docs]</a>    <span class="k">def</span> <span class="nf">optimizeObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">getter</span><span class="p">,</span> <span class="n">toWhiteList</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">getter</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">getter</span><span class="o">.</span><span class="n">raw</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;given a dead reference&quot;</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepAlive</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">toWhiteList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">whitelist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flag</span></div>

<div class="viewcode-block" id="ResourceManager.keepAlive"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager.keepAlive">[docs]</a>    <span class="k">def</span> <span class="nf">keepAlive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="p">:</span>
            <span class="c1">#self._free(key)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Already ketp alive&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSizeOf</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="c1"># needed memory to allocate</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizeMemory</span><span class="p">(</span><span class="n">needed</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">flag</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># manage memory to allocate new object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span> <span class="o">+=</span> <span class="n">s</span> <span class="c1"># update kept memory</span>
            <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _free memory from keptAlive</span>
<span class="sd">        :param key:</span>
<span class="sd">        :return: Liberated memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSizeOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span> <span class="o">-=</span> <span class="n">s</span> <span class="c1"># update kept memory</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="ResourceManager.bytes2units"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager.bytes2units">[docs]</a>    <span class="k">def</span> <span class="nf">bytes2units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        converts value from bytes to user units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">old_div</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResourceManager.units2bytes"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager.units2bytes">[docs]</a>    <span class="k">def</span> <span class="nf">units2bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        converts value from user units two bytes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_conv</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">usedMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: used memory in user units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes2units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refMemory</span><span class="p">)</span>

    <span class="nd">@usedMemory</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">usedMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;variable not settable&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes2units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span><span class="p">)</span>

    <span class="nd">@maxMemory</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">maxMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: maximum memory configured to be unlimited&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: maximum memory is </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units2bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="c1"># pass in bytes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="c1"># re calculate limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimizeMemory</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">margin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: margin used for triggering memory optimization from maxMemory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_margin</span>

    <span class="nd">@margin</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">margin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">value</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Margin must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="c1"># set limit to maxMemory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span> <span class="o">*</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_margin</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimizeMemory</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: all flag, if True: used memory is from all alive references,</span>
<span class="sd">                        if False: used memory is only from keptAlive references.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span>

    <span class="nd">@all</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="o">!=</span> <span class="n">flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="o">=</span> <span class="n">flag</span>
            <span class="c1"># TODO  recaculate usedMemory every time all changes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: user defined units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span>

    <span class="nd">@unit</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span><span class="s2">&quot;byte&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span><span class="s2">&quot;mb&quot;</span><span class="p">,</span><span class="s2">&quot;megabytes&quot;</span><span class="p">,</span><span class="s2">&quot;megas&quot;</span><span class="p">,</span><span class="s2">&quot;mega&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span>
        <span class="k">elif</span> <span class="n">unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span><span class="s2">&quot;gb&quot;</span><span class="p">,</span><span class="s2">&quot;gigas&quot;</span><span class="p">,</span><span class="s2">&quot;gigabytes&quot;</span><span class="p">,</span><span class="s2">&quot;giga&quot;</span><span class="p">,</span><span class="s2">&quot;gigabyte&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span> <span class="o">=</span>  <span class="mi">1000</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unit &#39;</span><span class="si">{}</span><span class="s2">&#39; not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span> <span class="o">=</span> <span class="n">unit</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceManager.resetGetter"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager.resetGetter">[docs]</a>    <span class="k">def</span> <span class="nf">resetGetter</span><span class="p">(</span><span class="n">getter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to reset getter parameters.</span>

<span class="sd">        :param getter: any instance of objectGetter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getter</span><span class="o">.</span><span class="n">_fails</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># init fail count</span>
        <span class="n">getter</span><span class="o">.</span><span class="n">_calls</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># init call count</span>
        <span class="n">getter</span><span class="o">.</span><span class="n">_processT</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># init mean of retrieving time</span>
        <span class="n">getter</span><span class="o">.</span><span class="n">_iddleT</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="ResourceManager.register"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.ResourceManager.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register object to retrieve.</span>

<span class="sd">        :param key: hashable key to retrieve</span>
<span class="sd">        :param method: callable method to get object</span>
<span class="sd">        :param instance: object instance already created from method</span>

<span class="sd">        .. note:: This method is used in __setitem__ as self.register(key, value). Overwrite this</span>
<span class="sd">                    method to change key assignation behaviour.</span>

<span class="sd">        Example::</span>

<span class="sd">            def mymethod():</span>
<span class="sd">                class constructor: pass</span>
<span class="sd">                return constructor()</span>

<span class="sd">            ret = retriever()</span>
<span class="sd">            ret[&quot;obj&quot;] = mymethod # register creating method in &quot;obj&quot;</span>
<span class="sd">            im = ret[&quot;obj&quot;] # get object (created obj +1, with reference)</span>
<span class="sd">            assert im is ret[&quot;obj&quot;] # check that it gets the same object</span>
<span class="sd">            # it remembers that &quot;obj&quot; is last registered or fetched object too</span>
<span class="sd">            assert ret() is ret()</span>
<span class="sd">            # lets register with better control (created obj2 +1, no reference)</span>
<span class="sd">            ret.register(&quot;obj2&quot;,mymethod(),mymethod)</span>
<span class="sd">            # proves that obj2 is not the same as obj (created obj2 +1, no reference)</span>
<span class="sd">            assert ret() is not ret[&quot;obj&quot;]</span>
<span class="sd">            print list(ret.iteritems()) # get items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">:</span>
            <span class="n">getter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">getter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">obj</span> <span class="o">=</span> <span class="n">instance</span><span class="p">,</span> <span class="n">callfunc</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">getter</span> <span class="o">=</span> <span class="n">ObjectGetter</span><span class="p">(</span><span class="n">obj</span> <span class="o">=</span> <span class="n">instance</span><span class="p">,</span> <span class="n">callfunc</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resetGetter</span><span class="p">(</span><span class="n">getter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">getter</span>
        <span class="k">if</span> <span class="n">instance</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizeObject</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">getter</span><span class="p">,</span><span class="n">toWhiteList</span><span class="o">=</span> <span class="ow">not</span> <span class="n">getter</span><span class="o">.</span><span class="n">isCreatable</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastKey</span> <span class="o">=</span> <span class="n">key</span> <span class="c1"># register last key</span></div>

    <span class="k">def</span> <span class="nf">_checkMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if memory needs to be optimized.</span>

<span class="sd">        :param asValue: True to return positive (how much memory needed to _free)</span>
<span class="sd">                        or negative (how much memory until limit reached) value.</span>
<span class="sd">                        False to return Value (how much memory needed to _free) or None.</span>
<span class="sd">        :return Memory value or None if no capacity to allocate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">needed</span><span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span><span class="p">:</span>
                <span class="k">return</span> <span class="c1"># indicates not capacity</span>
            <span class="k">if</span> <span class="n">needed</span><span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span> <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxMemory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refMemory</span> <span class="o">+</span> <span class="n">needed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span> <span class="o">+</span> <span class="n">needed</span>
            <span class="k">return</span> <span class="n">val</span> <span class="o">-</span> <span class="n">limit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="c1"># return 0 bytes to free</span>

    <span class="k">def</span> <span class="nf">_getOrderedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">all</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct list of alive objects.</span>

<span class="sd">        :param method: method to use from self.methods, if None use self.method.</span>
<span class="sd">        :param all: if True: all alive objects in the references</span>
<span class="sd">                    (of course if they are kept alive by self.keptAlive then they are alive in references).</span>
<span class="sd">                    else False: only objects kept alive by self.keptAlive.</span>
<span class="sd">        :param self.method: specifies the method to calculate and</span>
<span class="sd">                            sort according to the third column in list</span>
<span class="sd">        :return: list with items (key,size,calculated)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span>
        <span class="k">if</span> <span class="nb">all</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="c1"># let user data pass or choose default</span>
        <span class="n">usemethod</span> <span class="o">=</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;size&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># frame: key, size, calls, fails</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">getter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">references</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">getter</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">getter</span><span class="o">.</span><span class="n">raw</span><span class="p">()</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSizeOf</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">usemethod</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">usemethod</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSizeOf</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">usemethod</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">usemethod</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="c1"># sort just by size</span>
            <span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">invert</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">usemethod</span><span class="p">:</span> <span class="c1"># sort by user defined val</span>
            <span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">invert</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_optimizeMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param ret: dictionary or retriever</span>
<span class="sd">        :param _limit: _limit of memory</span>
<span class="sd">        :param margin:</span>
<span class="sd">        :param unit:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO liberate needed memory</span>
        <span class="c1"># ideal: total = media*len(sizes) &lt; limit*margin</span>
        <span class="c1"># if limit&lt; total &gt; limit*percent then eliminate</span>
        <span class="c1"># methods: None, by ascendant, by descendant, by creations</span>
        <span class="n">tofree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkMemory</span><span class="p">(</span><span class="n">needed</span><span class="o">=</span><span class="n">needed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tofree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="c1"># nothing to do, not capacity to allocate</span>

        <span class="k">if</span> <span class="n">tofree</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tofree</span> <span class="c1"># successful</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes2units</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> used of </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">usedMemory</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxMemory</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> needs to be freed to allocate </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">c</span><span class="p">(</span><span class="n">tofree</span><span class="p">),</span><span class="n">c</span><span class="p">(</span><span class="n">needed</span><span class="p">)))</span>

        <span class="c1"># FIRST STAGE</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="p">)</span>
        <span class="c1"># first eliminate in black list</span>
        <span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">blacklist</span><span class="p">)</span> <span class="ow">and</span> <span class="n">freed</span><span class="o">&gt;=</span><span class="n">tofree</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">blacklist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">freed</span> <span class="o">+=</span> <span class="n">size</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Eliminated &#39;</span><span class="si">{}</span><span class="s2">&#39; of size </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">c</span><span class="p">(</span><span class="n">size</span><span class="p">),</span><span class="n">unit</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="c1"># liminate in real black list</span>

        <span class="n">tofree</span> <span class="o">-=</span> <span class="n">freed</span>
        <span class="k">if</span> <span class="n">tofree</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> where freed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">freed</span><span class="p">),</span><span class="n">unit</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">tofree</span> <span class="c1"># successful</span>

        <span class="c1"># SECOND STAGE: if it did not work keep freeing</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOrderedData</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># get only in keptAlive</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">keys</span><span class="p">,</span><span class="n">sizes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># just needed keys and sizes</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span> <span class="c1"># total used memory in bytes</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">total</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span> <span class="c1"># difference of 10 bytes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keptMemory</span> <span class="o">=</span> <span class="n">total</span>
                <span class="n">tofree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkMemory</span><span class="p">(</span><span class="n">needed</span><span class="o">=</span><span class="n">needed</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: data was not well collected&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tofree</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1">#ratios = np.array(sizes)/total</span>
                <span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">sizes</span><span class="p">):</span> <span class="c1"># free only normal ones</span>
                    <span class="k">if</span> <span class="n">freed</span><span class="o">&gt;=</span><span class="n">tofree</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitelist</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keptAlive</span><span class="p">:</span>
                        <span class="n">size2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">freed</span> <span class="o">+=</span> <span class="n">size2</span>
                        <span class="k">if</span> <span class="n">size2</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: key </span><span class="si">{0}</span><span class="s2"> had size </span><span class="si">{1}</span><span class="s2"> but was freed </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">size2</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Eliminated &#39;</span><span class="si">{}</span><span class="s2">&#39; of size </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">c</span><span class="p">(</span><span class="n">size</span><span class="p">),</span><span class="n">unit</span><span class="p">))</span>
                <span class="n">tofree</span><span class="o">-=</span> <span class="n">freed</span>
                <span class="k">if</span> <span class="n">tofree</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> not adequately freed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">tofree</span><span class="p">),</span><span class="n">unit</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> where freed, remaining </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">freed</span><span class="p">),</span><span class="n">c</span><span class="p">(</span><span class="n">total</span><span class="o">-</span><span class="n">freed</span><span class="p">),</span><span class="n">unit</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> is an optimal memory. Not optimized.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">total</span><span class="p">),</span><span class="n">unit</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> is considered low memory. Not optimized.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">usedMemory</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tofree</span> <span class="c1"># this means: &gt; 0 bytes not able to free; &lt; 0 bytes over freed; == 0 successful</span></div>

<div class="viewcode-block" id="mapper"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.mapper">[docs]</a><span class="k">def</span> <span class="nf">mapper</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">onlynumpy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save and load or map live objects to disk to free RAM memory.</span>

<span class="sd">    :param path: path to save mapped file.</span>
<span class="sd">    :param obj: the object to map, if None it tries to load obj from path if exist</span>
<span class="sd">    :param mode: {None, &#39;r+&#39;, &#39;r&#39;, &#39;w+&#39;, &#39;c&#39;}.</span>
<span class="sd">    :param onlynumpy: if True, it saves a numpy mapper from obj.</span>
<span class="sd">    :return: mmap image, names of mmap files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">onlynumpy</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npy&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">+=</span> <span class="s2">&quot;.npy&quot;</span> <span class="c1"># correct path</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">numpySave</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span> <span class="c1"># save numpy array</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="c1"># simulates answer as onlynumpy = False</span>
        <span class="k">return</span> <span class="n">numpyLoad</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">mode</span><span class="p">),</span><span class="n">names</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="c1"># dump object to file for mapping</span>
        <span class="k">return</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="n">mode</span><span class="p">),</span> <span class="n">names</span></div>

<div class="viewcode-block" id="MemoizedDict"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.MemoizedDict">[docs]</a><span class="k">class</span> <span class="nc">MemoizedDict</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Memoized dictionary with keys and values persisted to files.</span>

<span class="sd">    :param path: path to save memo file</span>
<span class="sd">    :param mode: loading mode from memo file {None, &#39;r+&#39;, &#39;r&#39;, &#39;w+&#39;, &#39;c&#39;}</span>

<span class="sd">    .. note::</span>

<span class="sd">        If saveAtKey is True it will attempt to memoize each time a keyword is added</span>
<span class="sd">        and throw an error if not successful. But if saveAtKey is False this process</span>
<span class="sd">        will be carried out when the MemoizedDict instance is being destroyed in</span>
<span class="sd">        a proper deletion, that is, if the program ends unexpectedly all data will be</span>
<span class="sd">        lost or if data cannot be saved it will be lost without warning.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Some data structures cannot be memoize, so this structure is not save yet.</span>
<span class="sd">        Use at your own risk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#from directory import checkFile, checkDir, mkPath, rmFile</span>
        <span class="kn">from</span> <span class="nn">.directory</span> <span class="k">import</span> <span class="n">mkPath</span>
        <span class="kn">import</span> <span class="nn">pickle</span>
        <span class="c1"># TODO: change serializer to use json (it seems it is more reliable and compatible)</span>
        <span class="c1"># TODO: It is slow load key per key, consider making a way to load al de dictionary keys quickly</span>
        <span class="c1"># TODO: when clear is called, delete all memoized folder instead each key. it could be dangerous but faster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map_serializer</span> <span class="o">=</span> <span class="n">pickle</span> <span class="c1"># serializer for keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">mkPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="c1"># path to memoized keys and values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="c1"># file containing the keys</span>
        <span class="c1">#self._map = self._load_map() or {} # keeps the map to persistent files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="c1"># mode to read the values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span> <span class="c1"># loader for values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saver</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span> <span class="c1"># saver for values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span> <span class="o">=</span> <span class="nb">hash</span> <span class="c1"># function to hash the keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_secure</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># this is an option to use dangerous and secure routines</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_map</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span>
    <span class="nd">@_map</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">VariableNotSettable</span><span class="p">(</span><span class="s2">&quot;_map cannot be set&quot;</span><span class="p">)</span>
    <span class="nd">@_map</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">VariableNotDeletable</span><span class="p">(</span><span class="s2">&quot;_map cannot be deleted&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getHash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hasher function to use in persistent files.</span>

<span class="sd">        :param key: key to hash</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads key from persistent file using map.</span>

<span class="sd">        :param key: hashable key.</span>
<span class="sd">        :return: value stored in key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hashed</span><span class="p">,</span><span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">hashed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">EOFError</span><span class="p">,</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CorruptPersistent</span><span class="p">(</span><span class="s2">&quot;Persistent data is corrupt&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>

    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        saves key to persistent files.</span>

<span class="sd">        :param key: hashable key.</span>
<span class="sd">        :param value: serializable object.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hashed</span><span class="p">,</span><span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span> <span class="c1"># remove old keys</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># FIXME enclose in try/except, who knows files could be deleted</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1"># file could have been deleted</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">hashed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getHash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">hashed</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: Consider implementing a set to keep track of hashes so that a hash is not repeated</span>
            <span class="c1"># TODO: though add overloads, consider persisting the key along the value too for recovery purposes.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hashed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_saver</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_map</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Race condition in the creation of the directory &quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        persist dictionary map to file (metadata).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># FIXME: consumes too much time</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_serializer</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="c1"># save dictionary</span>

    <span class="k">def</span> <span class="nf">_load_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        loads metadata of dictionary map from persisted file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_serializer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="c1"># get session</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

<div class="viewcode-block" id="MemoizedDict.clear"><a class="viewcode-back" href="../../../RRtoolbox.lib.html#RRtoolbox.lib.cache.MemoizedDict.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># overloads clear in the abc class</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all items from D.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for security it is better to wait until all keys are</span>
        <span class="c1"># safely deleted and not deleting everything at once</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # This is really dangerous, an user could change the _path</span>
<span class="sd">        # variable and delete something else. Or if there exists</span>
<span class="sd">        # a symbolic link it could bring problems.</span>
<span class="sd">        # http://stackoverflow.com/a/185941/5288758</span>
<span class="sd">        folder = self._path</span>
<span class="sd">        for the_file in os.listdir(folder):</span>
<span class="sd">            file_path = os.path.join(folder, the_file)</span>
<span class="sd">            try:</span>
<span class="sd">                if os.path.isfile(file_path):</span>
<span class="sd">                    os.unlink(file_path)</span>
<span class="sd">                #elif os.path.isdir(file_path): shutil.rmtree(file_path)</span>
<span class="sd">            except Exception as e:</span>
<span class="sd">                print(e)</span>
<span class="sd">        self._map.clear()</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">hashed</span><span class="p">,</span><span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span> <span class="c1"># remove old keys</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># FIXME enclose in try/except, who knows files could be deleted</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># file could have been deleted</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_old</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_map</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#self[key] # It has to load values taking too long</span>
            <span class="n">hashed</span><span class="p">,</span><span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># test that key is in map</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span> <span class="c1"># test that key really exists in disk</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, David Toro.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>